const translations = {
  de: {
    "page.title": "Kaliningrad Immobilienbegleitung",
    "language.switcherLabel": "Sprache",
    "contact.phoneLabel": "Telefon",
    "contact.phoneValue": "+49 30 123 4567",
    "contact.emailLabel": "E-Mail",
    "contact.emailValue": "info@kaliningrad-immobilien.de",
    "contact.hoursLabel": "Sprechzeiten",
    "contact.hoursValue": "Montag – Freitag, 09:00 – 18:00 Uhr",
    "contact.addressLabel": "Standort",
    "contact.addressValue": "Kaliningrader Gebiet, Russische Föderation",
    "contactInfo.heading": "Ihr direkter Draht zu uns",
    "contactInfo.text": "Kontaktieren Sie uns für eine erste Einschätzung Ihres Vorhabens.",
    "hero.title": "Verlässliche Immobilienunterstützung im Kaliningrader Gebiet",
    "hero.subtitle": "Wir begleiten Sie durch jeden Schritt Ihrer Immobilieninvestition – vom ersten Vertrag bis zur sicheren Übergabe.",
    "hero.point1": "Verständliche Beratung für deutsche und europäische Klient:innen",
    "hero.point2": "Prüfung und Erstellung rechtssicherer Kaufunterlagen",
    "hero.point3": "Betreuung vor Ort mit lokalen Expert:innen",
    "hero.button": "Beratung anfordern",
    "about.heading": "Über uns",
    "about.paragraph1": "Unser spezialisiertes Team verbindet deutsches Serviceverständnis mit lokaler Expertise im Kaliningrader Gebiet.",
    "about.paragraph2": "Wir arbeiten transparent, erklären jeden Schritt verständlich und halten Sie stets auf dem Laufenden.",
    "about.listTitle": "Was uns auszeichnet",
    "about.point1": "Mehrsprachige Fachleute mit Erfahrung in EU-Russland-Transaktionen",
    "about.point2": "Klares Kostenmodell ohne versteckte Gebühren",
    "about.point3": "Persönliche Betreuung – telefonisch, online oder vor Ort",
    "services.heading": "Unsere Leistungen",
    "services.intro": "Wir übernehmen die vollständige Vorbereitung Ihrer Immobilientransaktion.",
    "services.contract.title": "Vertragsvorbereitung",
    "services.contract.text": "Ausarbeitung und Prüfung von Kauf- und Mietverträgen nach deutschen und russischen Standards.",
    "services.documents.title": "Dokumentenservice",
    "services.documents.text": "Beschaffung und Übersetzung aller notwendigen Unterlagen für Behörden und Banken.",
    "services.transaction.title": "Transaktionsbetreuung",
    "services.transaction.text": "Koordination mit Eigentümer:innen, Notar:innen und Behörden bis zum erfolgreichen Abschluss.",
    "consult.heading": "Beratung anfordern",
    "consult.description": "Senden Sie uns Ihre Kontaktdaten und kurze Angaben zum Objekt. Wir melden uns werktags innerhalb von 24 Stunden.",
    "consult.form.nameLabel": "Name",
    "consult.form.namePlaceholder": "Ihr vollständiger Name",
    "consult.form.emailLabel": "E-Mail",
    "consult.form.emailPlaceholder": "Ihre E-Mail-Adresse",
    "consult.form.phoneLabel": "Telefon",
    "consult.form.phonePlaceholder": "Ihre Telefonnummer",
    "consult.form.messageLabel": "Nachricht",
    "consult.form.messagePlaceholder": "Beschreiben Sie Ihr Anliegen oder das Objekt.",
    "consult.form.consent": "Ich stimme der Verarbeitung meiner Daten zum Zweck der Kontaktaufnahme zu.",
    "consult.form.submit": "Nachricht senden",
    "consult.form.success": "Vielen Dank! Wir melden uns in Kürze.",
    "consult.form.error": "Bitte füllen Sie alle Pflichtfelder korrekt aus.",
    "footer.rights": "© Kaliningrad Immobilienbegleitung. Alle Rechte vorbehalten."
  },
  en: {
    "page.title": "Kaliningrad Real Estate Support",
    "language.switcherLabel": "Language",
    "contact.phoneLabel": "Phone",
    "contact.phoneValue": "+49 30 123 4567",
    "contact.emailLabel": "Email",
    "contact.emailValue": "info@kaliningrad-immobilien.de",
    "contact.hoursLabel": "Office hours",
    "contact.hoursValue": "Monday – Friday, 9:00 – 18:00",
    "contact.addressLabel": "Location",
    "contact.addressValue": "Kaliningrad region, Russian Federation",
    "contactInfo.heading": "Your direct line to us",
    "contactInfo.text": "Get in touch for an initial assessment of your plans.",
    "hero.title": "Reliable real estate assistance in the Kaliningrad region",
    "hero.subtitle": "We accompany you through every step of your property investment – from the first draft to a safe handover.",
    "hero.point1": "Clear guidance for clients from Germany and across the EU",
    "hero.point2": "Drafting and reviewing compliant purchase documentation",
    "hero.point3": "On-site coordination with trusted local specialists",
    "hero.button": "Request consultation",
    "about.heading": "About us",
    "about.paragraph1": "Our dedicated team combines German-quality service with local expertise in the Kaliningrad region.",
    "about.paragraph2": "We keep the process transparent, explain every step in plain language, and keep you informed.",
    "about.listTitle": "Why clients choose us",
    "about.point1": "Multilingual professionals experienced in EU–Russia transactions",
    "about.point2": "Clear pricing with no hidden fees",
    "about.point3": "Personal support – by phone, online, or on location",
    "services.heading": "What we do",
    "services.intro": "We take care of the complete preparation of your property transaction.",
    "services.contract.title": "Contract preparation",
    "services.contract.text": "Drafting and verifying purchase and rental contracts compliant with German and Russian regulations.",
    "services.documents.title": "Documentation",
    "services.documents.text": "Collecting and translating all required papers for authorities and financial institutions.",
    "services.transaction.title": "Transaction support",
    "services.transaction.text": "Coordinating with owners, notaries, and authorities until the deal is successfully closed.",
    "consult.heading": "Request a consultation",
    "consult.description": "Share your contact details and a short description of the property. We respond within one business day.",
    "consult.form.nameLabel": "Name",
    "consult.form.namePlaceholder": "Your full name",
    "consult.form.emailLabel": "Email",
    "consult.form.emailPlaceholder": "Your email address",
    "consult.form.phoneLabel": "Phone",
    "consult.form.phonePlaceholder": "Your phone number",
    "consult.form.messageLabel": "Message",
    "consult.form.messagePlaceholder": "Describe your request or property details.",
    "consult.form.consent": "I agree that my data will be used to process this consultation request.",
    "consult.form.submit": "Send message",
    "consult.form.success": "Thank you! We will contact you shortly.",
    "consult.form.error": "Please complete all required fields correctly.",
    "footer.rights": "© Kaliningrad Real Estate Support. All rights reserved."
  }
};

const EU_COUNTRIES = new Set([
  "AT",
  "BE",
  "BG",
  "HR",
  "CY",
  "CZ",
  "DK",
  "EE",
  "FI",
  "FR",
  "DE",
  "GR",
  "HU",
  "IE",
  "IT",
  "LV",
  "LT",
  "LU",
  "MT",
  "NL",
  "PL",
  "PT",
  "RO",
  "SK",
  "SI",
  "ES",
  "SE"
]);

let currentLanguage = "de";
let manualLanguageSelection = false;

const languageButtons = () => document.querySelectorAll(".language-button");
const formElement = () => document.querySelector("#consultation-form");
const formResponseElement = () => document.querySelector("#form-response");

function updateLanguage(lang, { manual = false } = {}) {
  if (!translations[lang]) {
    lang = "de";
  }
  currentLanguage = lang;
  if (manual) {
    manualLanguageSelection = true;
  }
  document.documentElement.lang = lang;
  applyTranslations(lang);
  updateDocumentTitle(lang);
  updateLanguageButtons(lang);
}

function applyTranslations(lang) {
  const dictionary = translations[lang];
  if (!dictionary) {
    return;
  }

  document.querySelectorAll("[data-i18n]").forEach((element) => {
    const key = element.dataset.i18n;
    const translation = dictionary[key];
    if (translation) {
      element.textContent = translation;
    }
  });

  document.querySelectorAll("[data-i18n-placeholder]").forEach((element) => {
    const key = element.dataset.i18nPlaceholder;
    const translation = dictionary[key];
    if (translation) {
      element.setAttribute("placeholder", translation);
    }
  });

  document.querySelectorAll("[data-i18n-aria-label]").forEach((element) => {
    const key = element.dataset.i18nAriaLabel;
    const translation = dictionary[key];
    if (translation) {
      element.setAttribute("aria-label", translation);
    }
  });

  const responseEl = formResponseElement();
  if (responseEl && responseEl.dataset.messageType) {
    const responseKey = responseEl.dataset.messageType === "success" ? "consult.form.success" : "consult.form.error";
    const translation = dictionary[responseKey];
    if (translation) {
      responseEl.textContent = translation;
    }
  }
}

function updateDocumentTitle(lang) {
  const dictionary = translations[lang];
  if (dictionary && dictionary["page.title"]) {
    document.title = dictionary["page.title"];
  }
}

function updateLanguageButtons(activeLang) {
  languageButtons().forEach((button) => {
    const isActive = button.dataset.lang === activeLang;
    button.setAttribute("aria-pressed", String(isActive));
  });
}

function detectLanguage(fallbackLang) {
  if (!window.fetch || manualLanguageSelection) {
    return;
  }

  fetch("https://ipapi.co/json/")
    .then((response) => (response.ok ? response.json() : null))
    .then((data) => {
      if (!data || manualLanguageSelection) {
        return;
      }
      let detectedLanguage = fallbackLang;
      const countryCode = (data.country_code || "").toUpperCase();
      if (countryCode === "DE") {
        detectedLanguage = "de";
      } else if (EU_COUNTRIES.has(countryCode)) {
        detectedLanguage = "en";
      }
      updateLanguage(detectedLanguage);
    })
    .catch(() => {
      /* silent fallback */
    });
}

function handleFormSubmission() {
  const form = formElement();
  const responseEl = formResponseElement();
  if (!form || !responseEl) {
    return;
  }

  const clearMessage = () => {
    responseEl.textContent = "";
    responseEl.classList.remove("success", "error");
    delete responseEl.dataset.messageType;
  };

  const showMessage = (type) => {
    const key = type === "success" ? "consult.form.success" : "consult.form.error";
    const dictionary = translations[currentLanguage];
    const message = dictionary[key];
    responseEl.textContent = message || "";
    responseEl.classList.remove("success", "error");
    responseEl.classList.add(type);
    responseEl.dataset.messageType = type;
  };

  form.addEventListener("submit", (event) => {
    event.preventDefault();

    const fields = form.querySelectorAll("input, textarea");
    let hasErrors = false;

    fields.forEach((field) => {
      if (!field.checkValidity()) {
        field.classList.add("error");
        hasErrors = true;
      } else {
        field.classList.remove("error");
      }
    });

    if (hasErrors) {
      form.reportValidity();
      showMessage("error");
      return;
    }

    showMessage("success");
    form.reset();
  });

  form.addEventListener("input", (event) => {
    const target = event.target;
    if (!(target instanceof HTMLInputElement || target instanceof HTMLTextAreaElement)) {
      return;
    }
    if (target.classList.contains("error") && target.checkValidity()) {
      target.classList.remove("error");
    }
    if (responseEl.dataset.messageType === "error") {
      clearMessage();
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  const userLanguage = (navigator.language || navigator.userLanguage || "").toLowerCase();
  const fallbackLanguage = userLanguage.startsWith("de") ? "de" : "en";

  updateLanguage(fallbackLanguage);
  detectLanguage(fallbackLanguage);
  handleFormSubmission();

  languageButtons().forEach((button) => {
    button.addEventListener("click", () => {
      const selectedLang = button.dataset.lang;
      updateLanguage(selectedLang, { manual: true });
    });
  });
});
